<!DOCTYPE html>
<html>
    <body style="margin: 0px;overflow: hidden;">
        <canvas id="canvas"></canvas>
    </body>
</html>
<script src="./perlin.js"></script>
<script>

const MAX_ITERATIONS = 250;
const NOISE_WAVELENGTH = 300;
const WIND_STRENGTH = .05;
const COLOR_WAVELENGTH = Math.random() * 2000;

var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
var tracers = [];
var iterations;
var windSeedX;
var windSeedY;
var redSeed = Math.random();
var greenSeed = Math.random();
var blueSeed = Math.random();

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    windSeedX = Math.random();
    windSeedY = Math.random();
    colorSeed = Math.random();
    initializeTracers();
    paint();
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas, false);

function colorScale(noiseNum) {
    return Math.floor((noiseNum + 1) * 128);
}

function initializeTracers() {
    iterations = 0;
    tracers = [];
    for(var i = 0; i < canvas.width; i+=5) {
        noise.seed(colorSeed);
        red = colorScale(noise.simplex2(i/COLOR_WAVELENGTH, 100))
        green = colorScale(noise.simplex2(i/COLOR_WAVELENGTH, 200));
        blue = colorScale(noise.simplex2(i/COLOR_WAVELENGTH, 300));
        tracers.push({
            xOld: i,
            yOld: canvas.height,
            xNew: i,
            yNew: canvas.height,
            velocityX: 0,
            velocityY: -3,
            color: 'rgb('+red+', '+green+', '+blue+')'
        })
    }
}

function paint() {
    tracers.forEach(calculateNextStep);
    for(var i = 0; i < tracers.length -1; i++) {
        fillTracers(tracers[i], tracers[i+1]);
    }
    
    if(iterations < MAX_ITERATIONS) {
        iterations++;
        setTimeout(paint, 5);
    }
}

function calculateNextStep(tracer) {
    tracer.xOld = tracer.xNew;
    tracer.yOld = tracer.yNew;
    
    noise.seed(windSeedX);
    tracer.velocityX += noise.simplex2(tracer.xOld / NOISE_WAVELENGTH, tracer.yOld / NOISE_WAVELENGTH) * WIND_STRENGTH;
    tracer.xNew += tracer.velocityX;
    noise.seed(windSeedY);
    tracer.velocityY += noise.simplex2(tracer.xOld / NOISE_WAVELENGTH, tracer.yOld / NOISE_WAVELENGTH) * WIND_STRENGTH;
    tracer.yNew += tracer.velocityY;
    
    
}

function fillTracers(leftTracer, rightTracer) {
    ctx.strokeStyle = leftTracer.color;
    ctx.fillStyle = leftTracer.color;
    ctx.beginPath();
    ctx.moveTo(leftTracer.xOld, leftTracer.yOld);
    ctx.lineTo(leftTracer.xNew, leftTracer.yNew);
    ctx.lineTo(rightTracer.xNew, rightTracer.yNew);
    ctx.lineTo(rightTracer.xOld, rightTracer.yOld);
    ctx.closePath();
    ctx.fill()
    ctx.stroke();
}

</script>